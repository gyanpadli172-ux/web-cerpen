<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Website Kumpulan Cerpen</title>

  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      background: #f2f4f7; 
      color: #333; 
    }
    header { 
      background: linear-gradient(135deg, #5a3e85 0%, #7c4dff 100%); 
      color: white; 
      padding: 30px 20px; 
      text-align: center; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
    }
    main { 
      max-width: 1200px; 
      margin: auto; 
      padding: 20px; 
    }
    .menu { 
      display: flex; 
      justify-content: center; 
      gap: 20px; 
      margin-top: 30px; 
      flex-wrap: wrap; 
    }
    .btn { 
      background: linear-gradient(135deg, #6d48a8 0%, #9c27b0 100%); 
      color: white; 
      padding: 12px 20px; 
      border-radius: 8px; 
      cursor: pointer; 
      text-align: center; 
      font-size: 16px; 
      border: none; 
      transition: all 0.3s ease; 
    }
    .section { display: none; margin-top: 30px; }

    input[type="text"], textarea { 
      width: 100%; 
      padding: 12px; 
      margin-top: 10px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 16px; 
      box-sizing: border-box; 
    }

    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
      gap: 20px; 
      margin-top: 20px; 
    }
    
    .card { 
      background: white; 
      padding: 12px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.12); 
      cursor: pointer; 
    }

    .cover {
      width: 100%;
      height: 150px;
      background-size: cover;
      background-position: center;
      border-radius: 10px;
      box-shadow: inset 0 0 35px rgba(0,0,0,0.25);
      margin-bottom: 10px;
    }

    #detailCover {
      width: 380px;
      height: 250px;
      margin: auto;
      margin-bottom: 20px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      box-shadow: inset 0 0 45px rgba(0,0,0,0.3);
    }

    footer { 
      background: #5a3e85; 
      color: white; 
      text-align: center; 
      padding: 20px; 
      margin-top: 40px; 
    }
  </style>
</head>

<body>

<header>
  <h1>Kumpulan Cerpen Peserta Didik Kelas XI.XI</h1>
  <p>Bagikan karyamu dan baca karya teman-temanmu!</p>
</header>

<main>

  <div class="menu">
    <div class="btn" onclick="showSection('upload')">Unggah Cerpen</div>
    <div class="btn" onclick="showSection('articles')">Lihat Cerpen</div>
  </div>

  <!-- UPLOAD SECTION -->
  <div id="upload" class="section">
    <h2>Unggah Cerpen Baru</h2>

    <label>Nama Penulis *</label>
    <input type="text" id="namaPenulis">

    <label>Judul Cerpen *</label>
    <input type="text" id="judul">

    <label>Link Gambar Cover (opsional)</label>
    <input type="text" id="coverUrl" placeholder="Tempel link gambar cover">

    <label>Isi Cerpen *</label>
    <textarea id="isi"></textarea>

    <button class="btn" onclick="saveCerpen()">Simpan</button>
  </div>

  <!-- ARTICLES LIST -->
  <div id="articles" class="section">
    <h2>Kumpulan Cerpen</h2>
    <div id="list" class="grid"></div>
  </div>

  <!-- DETAIL SECTION -->
  <div id="detail" class="section">
    <div id="detailCover"></div>
    <h2 id="detailJudul"></h2>
    <p id="detailPenulis"></p>
    <p id="detailIsi" style="white-space: pre-wrap;"></p>
    <button class="btn" onclick="startEdit()">Edit</button>
    <button class="btn" onclick="showSection('articles')">Kembali</button>
  </div>

  <!-- EDIT SECTION -->
  <div id="edit" class="section">
    <h2>Edit Cerpen</h2>

    <label>Nama Penulis *</label>
    <input type="text" id="editNamaPenulis">

    <label>Judul Cerpen *</label>
    <input type="text" id="editJudul">

    <label>Link Gambar Cover (opsional)</label>
    <input type="text" id="editCoverUrl">

    <label>Isi Cerpen *</label>
    <textarea id="editIsi"></textarea>

    <button class="btn" onclick="updateCerpen()">Perbarui</button>
    <button class="btn" onclick="showSection('detail')">Batal</button>
  </div>

</main>

<footer>&copy; 2025 Website Kumpulan Cerpen</footer>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAtTEIsj-A_OY0wjkUFUcByG6XnStVqTSE",
    authDomain: "cerpenwoyla.firebaseapp.com",
    projectId: "cerpenwoyla",
    storageBucket: "cerpenwoyla.firebasestorage.app",
    messagingSenderId: "285662260886",
    appId: "1:285662260886:web:b2023d3a51c7e134f81cb7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let cerpenList = [];
  let currentIndex = -1;

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  }

  /* ============================================
     GOOGLE DRIVE AUTO CONVERTER
  ============================================ */
  function convertGoogleDriveToDirect(url) {
    if (!url) return null;

    // Pattern /d/FILEID/
    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match) {
      return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }

    // Pattern ?id=FILEID
    match = url.match(/id=([a-zA-Z0-9_-]+)/);
    if (match) {
      return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }

    return url;
  }

  function resolveCoverUrl(rawUrl) {
    if (!rawUrl) return '';
    rawUrl = rawUrl.trim();

    // Already image link
    if (rawUrl.match(/\.(jpg|jpeg|png|webp|gif)$/i)) return rawUrl;

    // Try convert Google Drive link
    const driveConverted = convertGoogleDriveToDirect(rawUrl);
    return driveConverted;
  }

  /* ============================================
     SAVE NEW CERPEN
  ============================================ */
  async function saveCerpen() {
    const namaPenulis = document.getElementById('namaPenulis').value.trim();
    const judul = document.getElementById('judul').value.trim();
    const isi = document.getElementById('isi').value.trim();
    const rawCover = document.getElementById('coverUrl').value.trim();

    if (!namaPenulis || !judul || !isi) {
      alert("Semua field wajib kecuali cover!");
      return;
    }

    const coverUrl = resolveCoverUrl(rawCover);

    db.collection("cerpensmanda").add({
      namaPenulis,
      judul,
      isi,
      coverUrl: coverUrl,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showSection('articles');
  }

  /* ============================================
     LISTENER & RENDER LIST
  ============================================ */
  db.collection("cerpensmanda")
    .orderBy("createdAt","asc")
    .onSnapshot(snapshot => {
      cerpenList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      updateList();
    });

  function updateList() {
    const container = document.getElementById('list');
    container.innerHTML = '';

    cerpenList.forEach((c, i) => {
      const div = document.createElement('div');
      div.className = 'card';
      div.onclick = () => openDetail(i);

      div.innerHTML = `
        <div class="cover" style="background-image:url('${c.coverUrl}'); background-color:${c.coverUrl ? 'transparent' : '#bdbdbd'};"></div>
        <h3>${c.judul}</h3>
        <p><b>Oleh:</b> ${c.namaPenulis}</p>
      `;

      container.appendChild(div);
    });
  }

  /* ============================================
     DETAIL VIEW
  ============================================ */
  function openDetail(i) {
    currentIndex = i;
    const c = cerpenList[i];

    document.getElementById('detailCover').style.backgroundImage = `url('${c.coverUrl}')`;
    document.getElementById('detailCover').style.backgroundColor = c.coverUrl ? 'transparent' : '#bdbdbd';
    detailJudul.innerText = c.judul;
    detailPenulis.innerText = "Oleh: " + c.namaPenulis;
    detailIsi.innerText = c.isi;

    showSection('detail');
  }

  /* ============================================
     EDIT
  ============================================ */
  function startEdit() {
    const c = cerpenList[currentIndex];

    editNamaPenulis.value = c.namaPenulis;
    editJudul.value = c.judul;
    editCoverUrl.value = c.coverUrl;
    editIsi.value = c.isi;

    showSection('edit');
  }

  async function updateCerpen() {
    const id = cerpenList[currentIndex].id;
    const rawCover = document.getElementById('editCoverUrl').value.trim();
    const coverUrl = resolveCoverUrl(rawCover);

    db.collection("cerpensmanda").doc(id).update({
      namaPenulis: editNamaPenulis.value,
      judul: editJudul.value,
      isi: editIsi.value,
      coverUrl: coverUrl
    });

    showSection('detail');
  }

  showSection('articles');
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kumpulan Cerpen — Dengan Cover dari Link</title>

  <style>
    :root{
      --accent1: #6d48a8;
      --accent2: #9c27b0;
      --bg: #f2f4f7;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg);
      color:#222;
    }
    header{
      background: linear-gradient(135deg,#5a3e85 0%, #7c4dff 100%);
      color:white;
      padding:28px 16px;
      text-align:center;
      box-shadow:0 4px 10px rgba(0,0,0,0.12);
    }
    header h1{ margin:0; font-size:1.9rem; }
    header p{ margin:6px 0 0; opacity:0.95 }

    main{ max-width:1100px; margin:24px auto; padding:16px; }

    .menu{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:18px; }
    .btn{
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      color:white; padding:10px 14px; border-radius:8px; border:none; cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    /* Form area */
    .form-card{
      background:white; border-radius:12px; padding:16px; box-shadow:var(--card-shadow); margin-bottom:22px;
    }
    label{ display:block; font-weight:600; margin-top:12px; font-size:0.95rem; color:#333 }
    input[type="text"], textarea, select{
      width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #d0d6dc; font-size:0.95rem;
    }
    textarea{ min-height:140px; resize:vertical; }

    .row{ display:flex; gap:12px; align-items:center; }
    .row .col{ flex:1; }

    /* preview small */
    .preview-small{
      width:130px; height:180px; border-radius:8px; background:#ddd; background-size:cover; background-position:center;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.25);
    }

    /* grid daftar buku */
    #list{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:18px;
      margin-top:12px;
    }

    .book-card{
      background:white; border-radius:10px; overflow:hidden; cursor:pointer; box-shadow:var(--card-shadow);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .book-card:hover{ transform: translateY(-6px); box-shadow:0 14px 40px rgba(0,0,0,0.18); }

    .book-cover{
      width:100%; height:220px; background:#bdbdbd; background-size:cover; background-position:center;
      display:block;
    }
    .book-meta{ padding:12px; }
    .book-meta h3{ margin:0 0 6px; font-size:1rem; line-height:1.2; }
    .book-meta p{ margin:0; color:#555; font-size:0.9rem; }

    /* detail */
    #detailView{ max-width:900px; margin:0 auto; }
    #detailCover{ width:100%; max-width:520px; height:320px; margin:0 auto 18px; border-radius:12px; background:#bdbdbd; background-size:cover; background-position:center; box-shadow:var(--card-shadow); }

    /* small screens */
    @media (max-width:640px){
      .row{ flex-direction:column; }
      .preview-small{ width:100%; height:160px; }
      .book-cover{ height:180px; }
    }

    .muted{ color:#777; font-size:0.9rem; }

    /* helper: hidden */
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <header>
    <h1>Kumpulan Cerpen — Kelas XI.XI</h1>
    <p>Tempel link gambar cover (Pinterest/Drive/etc.) atau biarkan kosong untuk warna default.</p>
  </header>

  <main>
    <div class="menu">
      <button class="btn" onclick="showSection('upload')">Unggah Cerpen</button>
      <button class="btn" onclick="showSection('articles')">Lihat Cerpen</button>
    </div>

    <!-- UPLOAD -->
    <section id="upload" class="section form-card hidden">
      <h2>Unggah Cerpen Baru</h2>

      <label for="namaPenulis">Nama Penulis *</label>
      <input id="namaPenulis" type="text" placeholder="Nama lengkap">

      <label for="judul">Judul Cerpen *</label>
      <input id="judul" type="text" placeholder="Judul cerpen">

      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <label for="coverUrl">Link Gambar Cover (opsional)</label>
          <input id="coverUrl" type="text" placeholder="Contoh: https://i.pinimg.com/...jpg atau https://pin.it/xxxx">
          <div class="muted" style="margin-top:6px;">Dapat menempel link Pinterest pendek (pin.it) — sistem akan mencoba ambil gambar secara otomatis.</div>
        </div>

        <div style="width:150px">
          <div style="font-weight:600; margin-bottom:8px;">Preview</div>
          <div id="previewBox" class="preview-small" style="background:#bdbdbd"></div>
        </div>
      </div>

      <label for="isi">Isi Cerpen *</label>
      <textarea id="isi" placeholder="Tulis cerpen..."></textarea>

      <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="btn" onclick="handleSave()" style="flex:1">Simpan Cerpen</button>
        <button class="btn" onclick="clearForm()" style="background:#777; flex:1">Bersihkan</button>
      </div>
    </section>

    <!-- ARTICLES -->
    <section id="articles" class="section">
      <h2>Daftar Cerpen</h2>
      <div id="list" aria-live="polite"></div>
    </section>

    <!-- DETAIL -->
    <section id="detail" class="section hidden">
      <div id="detailView" class="form-card">
        <div id="detailCover"></div>
        <h2 id="detailJudul"></h2>
        <p id="detailPenulis" class="muted"></p>
        <div id="detailIsi" style="white-space:pre-wrap; margin-top:12px;"></div>

        <div style="margin-top:14px; display:flex; gap:10px;">
          <button class="btn" onclick="startEdit()">Edit</button>
          <button class="btn" onclick="showSection('articles')" style="background:#777">Kembali</button>
        </div>
      </div>
    </section>

    <!-- EDIT -->
    <section id="edit" class="section form-card hidden">
      <h2>Edit Cerpen</h2>

      <label>Nama Penulis *</label>
      <input id="editNamaPenulis" type="text">

      <label>Judul *</label>
      <input id="editJudul" type="text">

      <label>Link Gambar Cover (opsional)</label>
      <input id="editCoverUrl" type="text" placeholder="Ganti link cover jika perlu">

      <label>Isi *</label>
      <textarea id="editIsi"></textarea>

      <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="btn" onclick="handleUpdate()" style="flex:1">Perbarui</button>
        <button class="btn" onclick="showSection('detail')" style="background:#777; flex:1">Batal</button>
      </div>
    </section>

  </main>

  <footer style="text-align:center; padding:18px 12px;">&copy; 2025 Kumpulan Cerpen</footer>

  <!-- Firebase compat libs (mudah) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /***** FIREBASE CONFIG *****/
    const firebaseConfig = {
      apiKey: "AIzaSyAtTEIsj-A_OY0wjkUFUcByG6XnStVqTSE",
      authDomain: "cerpenwoyla.firebaseapp.com",
      projectId: "cerpenwoyla",
      storageBucket: "cerpenwoyla.firebasestorage.app",
      messagingSenderId: "285662260886",
      appId: "1:285662260886:web:b2023d3a51c7e134f81cb7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collectionName = "cerpensmanda"; // sesuai konfirmasi

    // State
    let cerpenList = [];
    let currentIndex = -1; // index in cerpenList array

    // UI helpers
    const $ = id => document.getElementById(id);
    function showSection(id){
      document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden'));
      const el = $(id);
      if(el) el.classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Preview behavior for coverUrl input
    const previewBox = $('previewBox');
    $('coverUrl').addEventListener('input', async (e) => {
      const val = e.target.value.trim();
      if(!val){ previewBox.style.backgroundImage='none'; previewBox.style.backgroundColor='#bdbdbd'; return; }
      // try quick check if it's a direct image
      const resolved = await tryResolveImageUrl(val);
      if(resolved){
        previewBox.style.backgroundImage = `url('${resolved}')`;
        previewBox.style.backgroundColor = 'transparent';
      } else {
        previewBox.style.backgroundImage = 'none';
        previewBox.style.backgroundColor = '#bdbdbd';
      }
    });

    $('editCoverUrl').addEventListener('input', async (e) => {
      const val = e.target.value.trim();
      const el = $('detailCover');
      if(!val){ return; }
      const resolved = await tryResolveImageUrl(val);
      // don't auto-change detail here; just leave for update
    });

    // Utility: check if URL ends with image extension
    function looksLikeImageUrl(url){
      return /\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(url);
    }

    // Try to resolve an arbitrary URL into a direct image URL.
    // Strategy:
    // 1. If URL already looks like image -> return it
    // 2. If Google Drive share -> convert to uc?export=view&id=ID
    // 3. If Dropbox share -> add ?raw=1
    // 4. If pinterest short / pinterest page -> try fetch page and parse og:image
    // 5. Try fetch page and parse og:image
    // If all fails -> return null
    async function tryResolveImageUrl(url){
      if(!url) return null;
      // normalize
      try { url = url.trim(); } catch(e){}
      if(looksLikeImageUrl(url)) return url;

      // Google Drive
      // patterns: https://drive.google.com/file/d/FILEID/view?usp=sharing
      const driveMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if(driveMatch){
        return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;
      }
      // Dropbox share: https://www.dropbox.com/s/FILEID/name.jpg?dl=0 -> change dl=1 or raw=1
      if(url.includes('dropbox.com')){
        if(url.includes('?dl=0')) return url.replace('?dl=0','?raw=1');
        if(url.includes('?dl=1')) return url.replace('?dl=1','?raw=1');
        return url + (url.includes('?') ? '&raw=1' : '?raw=1');
      }

      // Pinterest short links & pinterest pages — attempt fetch & parse og:image
      // Also handles many other pages which embed og:image meta
      try {
        // Try fetching the page (may fail due to CORS)
        const resp = await fetch(url, { method:'GET', mode:'cors' });
        if(!resp.ok) {
          // some servers block; try using text but may throw
          // fallthrough to return null
        } else {
          const txt = await resp.text();
          // parse for og:image or twitter:image
          const ogMatch = txt.match(/<meta[^>]*property=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>/i)
                       || txt.match(/<meta[^>]*name=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>/i)
                       || txt.match(/<meta[^>]*name=["']twitter:image["'][^>]*content=["']([^"']+)["'][^>]*>/i);
          if(ogMatch && ogMatch[1]){
            const candidate = ogMatch[1].replace(/&amp;/g,'&').trim();
            if(looksLikeImageUrl(candidate)) return candidate;
            // sometimes og:image is a URL that redirects; still return it
            return candidate;
          }
        }
      } catch(e){
        // CORS or network error — can't fetch; ignore
      }

      // Lastly, for some pin.it short links we can attempt transforming:
      // If URL is like https://pin.it/abc  try prefixing with https://www.pinterest.com/pin/ and fetch that.
      // This is heuristic and may fail; we attempt to follow redirect by requesting the expanded url via fetch with mode 'no-cors' won't return content.
      if(url.includes('pin.it')){
        // Try calling pinterest share page (heuristic) — user may have to rely on manual copy if CORS blocks
        const tryUrl = url; // we still return null here, letting fallback handle it
        // no reliable client-side universal transform; return null to fallback
      }

      return null;
    }

    // Save cerpen — try to resolve cover URL before saving so Firestore stores resolved direct image when possible
    async function handleSave(){
      const nama = $('namaPenulis').value.trim();
      const jud = $('judul').value.trim();
      const isi = $('isi').value.trim();
      const rawCover = $('coverUrl').value.trim();

      if(!nama || !jud || !isi){
        alert('Nama, judul, dan isi wajib diisi.');
        return;
      }

      let coverUrl = '';
      if(rawCover){
        const resolved = await tryResolveImageUrl(rawCover);
        if(resolved) coverUrl = resolved;
        else {
          // if failed to resolve, still save the original link — we will try to load it directly on display; if it fails, UI will fallback
          coverUrl = rawCover;
        }
      }

      // write to Firestore
      db.collection(collectionName).add({
        namaPenulis: nama,
        judul: jud,
        isi: isi,
        coverUrl: coverUrl || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=> {
        // clear form & preview
        clearForm();
        showSection('articles');
      }).catch(err => {
        console.error('save error', err);
        alert('Gagal menyimpan. Cek console.');
      });
    }

    function clearForm(){
      $('namaPenulis').value='';
      $('judul').value='';
      $('coverUrl').value='';
      $('isi').value='';
      previewBox.style.backgroundImage='none';
      previewBox.style.backgroundColor='#bdbdbd';
    }

    // realtime listener
    db.collection(collectionName).orderBy('createdAt','desc').onSnapshot(snap=>{
      cerpenList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }) );
      renderList();
    }, err => {
      console.error('snapshot error', err);
    });

    function renderList(){
      const container = $('list');
      container.innerHTML='';
      cerpenList.forEach((c, idx) => {
        const card = document.createElement('div');
        card.className = 'book-card';
        // create inner
        const coverEl = document.createElement('div');
        coverEl.className = 'book-cover';
        // Attempt to set cover background. We'll test image by creating an Image object to see if it loads.
        if(c.coverUrl){
          // optimistic set; we also test
          coverEl.style.backgroundImage = `url('${c.coverUrl}')`;
        } else {
          coverEl.style.background = '#bdbdbd';
        }

        const meta = document.createElement('div');
        meta.className = 'book-meta';
        meta.innerHTML = `<h3>${escapeHtml(c.judul)}</h3><p>oleh ${escapeHtml(c.namaPenulis)}</p>`;

        card.appendChild(coverEl);
        card.appendChild(meta);

        // click -> open detail
        card.addEventListener('click', () => openDetail(idx));
        container.appendChild(card);

        // validate image load; if fails, fallback color
        if(c.coverUrl){
          testImageLoad(c.coverUrl).then(ok=>{
            if(!ok){
              coverEl.style.background = '#bdbdbd';
              coverEl.style.backgroundImage = 'none';
            }
          });
        }
      });
    }

    // try load image to check if URL is usable (resolves CORS: image element doesn't require CORS to display)
    function testImageLoad(url, timeout=5000){
      return new Promise(resolve=>{
        const img = new Image();
        let timed=false;
        const t = setTimeout(()=>{ timed=true; img.src=''; resolve(false); }, timeout);
        img.onload = () => { if(!timed){ clearTimeout(t); resolve(true); } };
        img.onerror = () => { if(!timed){ clearTimeout(t); resolve(false); } };
        img.src = url;
      });
    }

    // open detail view
    function openDetail(index){
      currentIndex = index;
      const c = cerpenList[index];
      if(!c) return;
      // set cover
      const dCover = $('detailCover');
      if(c.coverUrl){
        dCover.style.backgroundImage = `url('${c.coverUrl}')`;
        dCover.style.backgroundColor = 'transparent';
        // validate
        testImageLoad(c.coverUrl).then(ok=>{
          if(!ok){
            dCover.style.backgroundImage = 'none';
            dCover.style.backgroundColor = '#bdbdbd';
          }
        });
      } else {
        dCover.style.backgroundImage = 'none';
        dCover.style.backgroundColor = '#bdbdbd';
      }
      $('detailJudul').innerText = c.judul;
      $('detailPenulis').innerText = 'Oleh: ' + (c.namaPenulis||'');
      $('detailIsi').innerText = c.isi || '';
      showSection('detail');
    }

    // start edit
    function startEdit(){
      const c = cerpenList[currentIndex];
      if(!c) return alert('Tidak ada cerpen dipilih.');
      $('editNamaPenulis').value = c.namaPenulis || '';
      $('editJudul').value = c.judul || '';
      $('editCoverUrl').value = c.coverUrl || '';
      $('editIsi').value = c.isi || '';
      showSection('edit');
    }

    async function handleUpdate(){
      const c = cerpenList[currentIndex];
      if(!c) return alert('Tidak ada cerpen dipilih.');

      const nama = $('editNamaPenulis').value.trim();
      const jud = $('editJudul').value.trim();
      const isi = $('editIsi').value.trim();
      const rawCover = $('editCoverUrl').value.trim();

      if(!nama || !jud || !isi) return alert('Nama, judul, isi wajib diisi.');

      let coverUrl = '';
      if(rawCover){
        const resolved = await tryResolveImageUrl(rawCover);
        if(resolved) coverUrl = resolved;
        else coverUrl = rawCover;
      }

      db.collection(collectionName).doc(c.id).update({
        namaPenulis: nama,
        judul: jud,
        isi: isi,
        coverUrl: coverUrl || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        showSection('detail');
      }).catch(err=>{
        console.error('update err', err);
        alert('Gagal update. Cek console.');
      });
    }

    // small helpers
    function escapeHtml(text){
      if(!text) return '';
      return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // quick init: show list
    showSection('articles');

    // expose some functions for debug if needed
    window.showSection = showSection;
    window.handleSave = handleSave;
    window.handleUpdate = handleUpdate;
    window.startEdit = startEdit;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Website Kumpulan Cerpen</title>

  <!-- QUILL EDITOR CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f2f4f7; color: #333; }
    header { background: linear-gradient(135deg,#5a3e85,#7c4dff); color:white; padding:30px 20px; text-align:center; }
    main { max-width:1200px; margin:auto; padding:20px; }
    .menu { display:flex; justify-content:center; gap:20px; margin-top:30px; flex-wrap:wrap; }
    .btn { background:linear-gradient(135deg,#6d48a8,#9c27b0); color:white; padding:12px 20px; border-radius:8px; cursor:pointer; border:none; }
    .section { display:none; margin-top:30px; }
    input[type="text"] { width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:8px; font-size:16px; }
    .editor-container { margin-top:10px; border:1px solid #ddd; border-radius:8px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:20px; margin-top:20px; }
    .card { background:white; padding:12px; border-radius:12px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.12); }
    .cover { width:100%; height:160px; border-radius:10px; background-size:cover; background-position:center; margin-bottom:10px; }
    #detailCover { width:380px; height:250px; margin:auto; margin-bottom:20px; border-radius:12px; background-size:cover; background-position:center; }
    #detailIsi { text-align:justify; margin-top:20px; font-size:17px; line-height:1.55; }
    .small-note { font-size:0.9em; color:#666; margin-top:6px; }
    footer { background:#5a3e85; color:white; text-align:center; padding:20px; margin-top:40px; }
  </style>
</head>

<body>

<header>
  <h1>Kumpulan Cerpen Peserta Didik Kelas XI.XI SMAN 2 Kuningan</h1>
  <p>Bagikan karyamu dan baca karya teman-temanmu!</p>
</header>

<main>

  <div class="menu">
    <div class="btn" onclick="showSection('upload')">Unggah Cerpen</div>
    <div class="btn" onclick="showSection('articles')">Lihat Cerpen</div>
  </div>

  <!-- UPLOAD SECTION -->
  <div id="upload" class="section">
    <h2>Unggah Cerpen Baru</h2>

    <label>Nama Penulis *</label>
    <input type="text" id="namaPenulis">

    <label>Judul Cerpen *</label>
    <input type="text" id="judul">

    <label>Link Gambar Cover (opsional)</label>
    <input type="text" id="coverUrl" placeholder="Tempel link gambar cover (direct link)">

    <label>Kode Hapus (wajib) — simpan baik-baik!</label>
    <input type="text" id="deleteCode" placeholder="Contoh: 6 digit atau kombinasi huruf/angka">

    <label>Isi Cerpen *</label>
    <div id="editorUpload" class="editor-container"></div>
    <div class="small-note">Gunakan toolbar untuk bold, italic, bullet, indent, align.</div>

    <div style="margin-top:12px;">
      <button class="btn" onclick="saveCerpen()">Simpan</button>
    </div>
  </div>

  <!-- ARTICLES LIST -->
  <div id="articles" class="section">
    <h2>Kumpulan Cerpen</h2>
    <div id="list" class="grid"></div>
  </div>

  <!-- DETAIL SECTION -->
  <div id="detail" class="section">
    <div id="detailCover"></div>
    <h2 id="detailJudul"></h2>
    <p id="detailPenulis"></p>
    <div id="detailIsi"></div>

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button class="btn" onclick="startEdit()">Edit</button>
      <button class="btn" onclick="promptDelete()">Hapus Cerpen</button>
      <button class="btn" onclick="showSection('articles')">Kembali</button>
    </div>
  </div>

  <!-- EDIT SECTION -->
  <div id="edit" class="section">
    <h2>Edit Cerpen</h2>

    <label>Nama Penulis *</label>
    <input type="text" id="editNamaPenulis">

    <label>Judul Cerpen *</label>
    <input type="text" id="editJudul">

    <label>Link Gambar Cover (opsional)</label>
    <input type="text" id="editCoverUrl" placeholder="Tempel link gambar cover (direct link)">

    <label>Kode Hapus (isi jika ingin mengubah / kosongkan untuk tetap)</label>
    <input type="text" id="editDeleteCode" placeholder="Kosong = tetap kode lama">

    <label>Isi Cerpen *</label>
    <div id="editorEdit" class="editor-container"></div>

    <div style="margin-top:12px;">
      <button class="btn" onclick="updateCerpen()">Perbarui</button>
      <button class="btn" onclick="showSection('detail')">Batal</button>
    </div>
  </div>

</main>

<footer>&copy; 2025 Website Kumpulan Cerpen</footer>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- QUILL JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAtTEIsj-A_OY0wjkUFUcByG6XnStVqTSE",
    authDomain: "cerpenwoyla.firebaseapp.com",
    projectId: "cerpenwoyla",
    storageBucket: "cerpenwoyla.firebasestorage.app",
    messagingSenderId: "285662260886",
    appId: "1:285662260886:web:b2023d3a51c7e134f81cb7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let cerpenList = [];
  let currentIndex = -1;

  const toolbarOptions = [
    ['bold', 'italic', 'underline'],
    [{ 'align': [] }],
    [{ 'list': 'bullet' }],
    [{ 'indent': '-1'}, { 'indent': '+1' }]
  ];

  // Inisialisasi Quill editors
  const editorUpload = new Quill('#editorUpload', { theme: 'snow', modules:{ toolbar: toolbarOptions }});
  const editorEdit = new Quill('#editorEdit', { theme: 'snow', modules:{ toolbar: toolbarOptions }});

  // Tampilkan / sembunyikan section
  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    const el = document.getElementById(id);
    if (el) el.style.display='block';
  }

  // SIMPAN CERPEN (dengan deleteCode)
  async function saveCerpen() {
    const nama = document.getElementById('namaPenulis').value.trim();
    const judul = document.getElementById('judul').value.trim();
    const cover = document.getElementById('coverUrl').value.trim();
    const deleteCode = document.getElementById('deleteCode').value.trim();
    const isiHTML = editorUpload.root.innerHTML.trim();

    if (!nama || !judul) {
      alert('Nama penulis dan judul wajib diisi.');
      return;
    }

    // pastikan isi tidak kosong (Quill empty html is "<p><br></p>")
    if (isiHTML === '' || isiHTML === '<p><br></p>') {
      alert('Isi cerpen wajib diisi.');
      return;
    }

    if (!deleteCode) {
      alert('Kode hapus wajib diisi — simpan dan beri tahu penulis agar tidak hilang.');
      return;
    }

    // simpan ke Firestore
    try {
      await db.collection("cerpensmanda").add({
        namaPenulis: nama,
        judul,
        isi: isiHTML,
        coverUrl: cover || '',
        deleteCode: deleteCode,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // kosongkan form & editor
      document.getElementById('namaPenulis').value = '';
      document.getElementById('judul').value = '';
      document.getElementById('coverUrl').value = '';
      document.getElementById('deleteCode').value = '';
      editorUpload.root.innerHTML = '';

      alert('Cerpen berhasil disimpan. Ingat kode hapusmu!');
      showSection('articles');
    } catch (err) {
      console.error(err);
      alert('Gagal menyimpan cerpen. Cek console.');
    }
  }

  // Listener realtime dari Firestore
  db.collection("cerpensmanda")
    .orderBy("createdAt","asc")
    .onSnapshot(snapshot => {
      cerpenList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateList();
    }, err => {
      console.error('Firestore error:', err);
    });

  // Update daftar kartu
  function updateList(){
    const container = document.getElementById('list');
    container.innerHTML = '';

    cerpenList.forEach((c, i) => {
      const div = document.createElement('div');
      div.className = 'card';
      div.onclick = () => openDetail(i);

      const coverStyle = c.coverUrl && c.coverUrl.trim() !== ''
        ? `background-image:url('${c.coverUrl}'); background-color:transparent;`
        : `background-color:#bdbdbd;`;

      div.innerHTML = `
        <div class="cover" style="${coverStyle}"></div>
        <h3>${escapeHtml(c.judul)}</h3>
        <p><b>Oleh:</b> ${escapeHtml(c.namaPenulis)}</p>
      `;

      container.appendChild(div);
    });
  }

  // Buka detail cerpen
  function openDetail(i){
    currentIndex = i;
    const c = cerpenList[i];

    const detailCoverEl = document.getElementById('detailCover');
    if (c.coverUrl && c.coverUrl.trim() !== '') {
      detailCoverEl.style.backgroundImage = `url('${c.coverUrl}')`;
      detailCoverEl.style.backgroundColor = 'transparent';
    } else {
      detailCoverEl.style.backgroundImage = 'none';
      detailCoverEl.style.backgroundColor = '#bdbdbd';
    }

    document.getElementById('detailJudul').innerText = c.judul;
    document.getElementById('detailPenulis').innerText = 'Oleh: ' + c.namaPenulis;
    document.getElementById('detailIsi').innerHTML = c.isi || '';

    showSection('detail');
  }

  // Mulai edit (isi form edit)
  function startEdit(){
    if (currentIndex < 0 || currentIndex >= cerpenList.length) {
      alert('Pilih cerpen dulu.');
      return;
    }
    const c = cerpenList[currentIndex];
    document.getElementById('editNamaPenulis').value = c.namaPenulis || '';
    document.getElementById('editJudul').value = c.judul || '';
    document.getElementById('editCoverUrl').value = c.coverUrl || '';
    document.getElementById('editDeleteCode').value = ''; // kosongkan agar user sengaja mengisi jika ingin ganti
    editorEdit.root.innerHTML = c.isi || '';
    showSection('edit');
  }

  // Update cerpen (jika editDeleteCode kosong -> biarkan deleteCode lama)
  async function updateCerpen(){
    if (currentIndex < 0 || currentIndex >= cerpenList.length) {
      alert('Tidak ada cerpen yang dipilih.');
      return;
    }
    const id = cerpenList[currentIndex].id;
    const newNama = document.getElementById('editNamaPenulis').value.trim();
    const newJudul = document.getElementById('editJudul').value.trim();
    const newCover = document.getElementById('editCoverUrl').value.trim();
    const newDeleteCode = document.getElementById('editDeleteCode').value.trim(); // kosong = jangan ubah
    const newIsi = editorEdit.root.innerHTML.trim();

    if (!newNama || !newJudul) {
      alert('Nama penulis dan judul wajib diisi.');
      return;
    }
    if (newIsi === '' || newIsi === '<p><br></p>') {
      alert('Isi cerpen wajib diisi.');
      return;
    }

    // Siapkan payload update
    const payload = {
      namaPenulis: newNama,
      judul: newJudul,
      isi: newIsi,
      coverUrl: newCover
    };
    if (newDeleteCode) payload.deleteCode = newDeleteCode;

    try {
      await db.collection("cerpensmanda").doc(id).update(payload);
      alert('Cerpen diperbarui.');
      showSection('detail');
    } catch (err) {
      console.error(err);
      alert('Gagal memperbarui. Cek console.');
    }
  }

  // Hapus cerpen dengan verifikasi kode
  async function promptDelete() {
    if (currentIndex < 0 || currentIndex >= cerpenList.length) {
      alert('Tidak ada cerpen yang dipilih.');
      return;
    }
    const c = cerpenList[currentIndex];

    // Jika dokumen tidak punya deleteCode
    if (!c.deleteCode) {
      alert('Cerpen ini tidak memiliki kode hapus. Tidak dapat dihapus melalui fitur ini.');
      return;
    }

    const userInput = prompt('Masukkan kode hapus cerpen:');
    if (userInput === null) return; // cancel

    if (userInput.trim() === c.deleteCode) {
      // hapus
      try {
        await db.collection("cerpensmanda").doc(c.id).delete();
        alert('Cerpen berhasil dihapus.');
        showSection('articles');
      } catch (err) {
        console.error(err);
        alert('Gagal menghapus. Cek console.');
      }
    } else {
      alert('Kode salah. Cerpen tidak dihapus.');
    }
  }

  // Simple escaping untuk judul/penulis tampil di card
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // Start with articles view
  showSection('articles');
</script>

</body>
</html>